# Администрирование Linux. ДЗ №4
## Работа с RAID-массивами


## Цель:
> Практика нацелена на получение опыта работы с RAID-массивами, и с методами решения штатных проблем (замена дисков)

----------------

С чем балуемся: - С `mdadm`.

----------------

Что нужно сделать:
  - Собрать R0/R5/R10 (на выбор);
  - Сломать и починить RAID;
  - Проверить, что рейд собирается при перезагрузке;
  - Создать на созданном RAID-устройстве раздел и файловую систему;
  - Добавить запись в fstab для автомонтирования при перезагрузке.

----------------

### Ход работы:
1) Первым делом была развернута виртуальная машина под управленем ubuntu 18.04.5
2) Далее были добавлены в систему 5 виртуальных дисков по 1 Gb каждый.

В этом можно убедиться при помощи рисунка:

![Добавленные носители в систему](https://sun9-68.userapi.com/qIvDNeaqi7xsTNroeJCxdVp6mc9nqfQu0V5JdQ/arwLV5aZ5dk.jpg "Добавленные носители в систему")

3) Установлен пакет `mdadm` командой `sudo apt install mdadm`

4) Было решено создать RAID10-массив (и не потому что он приведен в примере, а потому что он мне более симпатичен)
Он обладает неплохой производительностью из-за дублирования (зеркального отображения одного диска на другой) и при этом запись идет чередованием, сначала на первый RAID1 из нескольких дисков, а потом на второй RAID1. Получается RAID0 из двух RAID1.
Для этого воспользуемся командой `sudo mdadm --create /dev/md0 -l 10 -n 4 /dev/sd{b..e}`

![Собранный RAID10](https://sun9-26.userapi.com/vPVWJ_I2UWq-NSyF-b8zOW2aMGs0w8whvePptw/-rM5d0e51nw.jpg "Собранный RAID10")

5) Проверим состояние, выполнением команд:
```
cat /proc/mdstat
sudo mdadm --detail /dev/md0
```

Состояние RAID, обнаруженных в системе:
![Состояние RAID, обнаруженных в системе](https://sun9-18.userapi.com/hq4_LSW0q2eJTVtLRS0vmcuOFd1iD73lwIk8Pg/Xg_Q3Ye9-zg.jpg "Состояние RAID, обнаруженных в системе")


6) Создадим ситуаию, что у нас "умер" оодин из дисков, пусть это будет ***sdd***. Но мы не будем делать всё, чтобы он действительно умер, а лишь пометим его как сбойный и извлечем его из массива. Для этого нам понадобится выполнить команды:
```
sudo mdadm /dev/md0 --fail /dev/sdd
sudo mdadm /dev/md0 --remove /dev/sdd
cat /proc/mdstat
sudo mdadm --detail /dev/md0
```

В результате выполнения данной последовательности команд получен следующий результат:
![Результат извлечения сломанного диска из RAID](https://sun9-76.userapi.com/fg9w9l1cBy4TQoXgXXvkDtXJmueSexgS1bShNw/9thskcR34AE.jpg "Результат извлечения сломанного диска из RAID")

Как видно из рисунка, третий диск находится в состоянии "***removed***".

7) Ну и теперь, надо же восстановить структуру RAID и добавить недостающий диск, для этого выполним следующую последовательность команд (допустив то, что мы уже знаем, что ~~дополнительный~~ резервный диск у нас на всякий случай установлен в систему и мы знаем наизусть его имя: 
```
sudo mdadm --add /dev/md0 /dev/sdf
cat /proc/mdstat
sudo mdadm --detail /dev/md0
```

Иначе, чтобы узнать имена подключенных дисков и некоторую информаию о них - можно было бы воспользоваться, например, командой `lsblk`.

Вот, что у нас получилось в результате:
![Результат добавления резервного диска в RAID](https://sun9-6.userapi.com/aqfCvvOcN9c25nkozPqbufERNbX_9RHoo0S4RA/AcOPfGZnkxg.jpg "Результат добавления резервного диска в RAID")

Как видно из рисунка, теперь структура RAID восстановлена. Все диски на своих местах в структуре, все активные и синхронизация дисков произведена.


8) Ну и, чтобы уж наверняка, добавимеще один диск всё той же командой `sudo mdadm --add /dev/md0`, с указанамием нами "замененного нового" диска `/dev/sdd`.


Теперь к интересненькому:

9) Создадим конфигурационный файл. Это делается командой `sudo mdadm --detail --scan > /etc/mdadm/mdadm.conf`, но данная команда завершалась ошибкой `bash: /etc/mdadm/mdadm.conf: Отказано в доступе`.

> Решение:
>> Выполнить командыe `sudo -i`, а затем уже `sudo mdadm --detail --scan > /etc/mdadm/mdadm.conf`.


10) Выполним остановку и запуск RAID-массива.

Основка выполняется командой `sudo mdadm --stop /dev/md0`
А запуск - командой `sudo mdadm --assemble /dev/md0`

Результат выполнения этих команд приведен на рисунке ниже:
![Результат выполнения остановки и запуска массива](https://sun1-87.userapi.com/VHZtdX6fvexFLe9jz80QxyCp9GCE4WkIQ8_4fA/dS01L6HdDP8.jpg "Результат выполнения остановки и запуска массива")


11) Самое страшное: выполнить перезагрузку. Собственно `sudo reboot`.

Как видно, даже после перезагруки машины мы получаем собранный RAID-массив, но с другим номером (127), что видно из рисунка ниже:

![Создаваемый нами массив после перезагрузки](https://sun9-23.userapi.com/aq52FEjnz4EO5HPem-ePPqdGUZSf2Ik9GOOcmg/n0hok7rNQgk.jpg "Создаваемый нами массив после перезагрузки")


12) Теперь создадим файловую систему, для этого воспользуемся командой `sudo fdisk /dev/md127`, далее либо пользуемся справкой (команда `m` ), либо выполняем по инструкции:
    1. нажимаем `n` - *добавление нового раздела*;
    1. далее `p` - *тип раздела основной*;
    1. далее либо нажимаем ***ENTER*** либо вводим `1` - *номер раздела*;
    1. после чего указываем размер раздела (мною был создан раздел размерром 520 мегабайт) командой `+520M`;
    1. Далее, чтобы сохранить результаты необходимо ввести команду `w` - *запись таблиы разделов на диск и выход*.

13) Создадим  файловую систему, для этого воспользуемся командой `sudo mkfs.ext4 /dev/md127p1`

14) Отредактируем файл `/etc/fstab` добавив строку следующего вида: `UUID=24d17f2f-53d3-4f79-a047-2410aa8d13ed	/mnt	ext4	defaults	0	0`

Но сначала надо узнать UUID диска, для этого воспользуемся командой `sudo blkid /dev/md127p1`, которая и отобразит нам нужный ***UUID***.

В результате получили вот это:
![Результат выполнения монтирования](https://sun9-14.userapi.com/jdFBlwt9ucfC8LXQtEpmppK2gKdL7j1ZZRSrBA/UeaXag7PmfU.jpg "Результат выполнения монтирования")

------------

На этом лабораторную работу считаю завершенной.

Nikel, 2020
